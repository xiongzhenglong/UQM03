<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¯è§†åŒ–ç”Ÿæˆæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            height: 100px;
            resize: vertical;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #40a9ff;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
        }
        .error {
            color: #ff4d4f;
            background: #fff2f0;
            border-color: #ffccc7;
        }
        .success {
            color: #52c41a;
            background: #f6ffed;
            border-color: #b7eb8f;
        }
        .loading {
            color: #1890ff;
        }
        .visualization-preview {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            background: white;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }
        th {
            background: #f5f5f5;
            font-weight: 500;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 15px;
        }
        
        .tab-button {
            padding: 8px 16px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .tab-button.active {
            border-bottom-color: #1890ff;
            color: #1890ff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 4px 4px 0 0;
        }
        
        .copy-btn {
            padding: 4px 8px;
            background: #1890ff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .copy-btn:hover {
            background: #40a9ff;
        }
        
        .code-block {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 0 0 4px 4px;
            padding: 12px;
            margin: 0;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AIå¯è§†åŒ–ç”Ÿæˆæµ‹è¯•</h1>
        
        <div class="form-group">
            <label for="visualizationType">å¯è§†åŒ–ç±»å‹:</label>
            <select id="visualizationType">
                <option value="auto">è‡ªåŠ¨é€‰æ‹©</option>
                <option value="table">è¡¨æ ¼</option>
                <option value="chart">å›¾è¡¨</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="query">å¯è§†åŒ–éœ€æ±‚æè¿°:</label>
            <textarea id="query" placeholder="è¯·æè¿°æ‚¨å¸Œæœ›å¦‚ä½•å¯è§†åŒ–è¿™äº›æ•°æ®ï¼Œä¾‹å¦‚ï¼š'ç”Ÿæˆä¸€ä¸ªæŒ‰éƒ¨é—¨ç»Ÿè®¡å¹³å‡è–ªèµ„çš„æŸ±çŠ¶å›¾' æˆ– 'åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰ç”¨æˆ·ä¿¡æ¯çš„è¡¨æ ¼'"></textarea>
        </div>
        
        <div class="form-group">
            <label for="testData">æµ‹è¯•æ•°æ® (JSONæ ¼å¼):</label>
            <textarea id="testData" placeholder="è¾“å…¥JSONæ ¼å¼çš„æµ‹è¯•æ•°æ®">[
  {"name": "å¼ ä¸‰", "age": 25, "salary": 8000, "department": "æŠ€æœ¯éƒ¨"},
  {"name": "æå››", "age": 30, "salary": 12000, "department": "é”€å”®éƒ¨"},
  {"name": "ç‹äº”", "age": 28, "salary": 10000, "department": "æŠ€æœ¯éƒ¨"},
  {"name": "èµµå…­", "age": 35, "salary": 15000, "department": "ç®¡ç†éƒ¨"},
  {"name": "é’±ä¸ƒ", "age": 27, "salary": 9000, "department": "æŠ€æœ¯éƒ¨"}
]</textarea>
        </div>
        
        <button onclick="generateVisualization()" id="generateBtn">ç”Ÿæˆå¯è§†åŒ–ä»£ç </button>
        
        <div id="result" class="result" style="display: none;"></div>
        
        <div id="visualizationPreview" class="visualization-preview" style="display: none;">
            <h3>å¯è§†åŒ–é¢„è§ˆ</h3>
            <div id="previewContent"></div>
        </div>
        
        <div id="codePreview" class="visualization-preview" style="display: none;">
            <h3>ç”Ÿæˆçš„ä»£ç </h3>
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('component')">ç»„ä»¶ä»£ç </button>
                <button class="tab-button" onclick="showTab('processing')">æ•°æ®å¤„ç†</button>
                <button class="tab-button" onclick="showTab('config')">é…ç½®JSON</button>
            </div>
            <div id="componentCode" class="tab-content active">
                <div class="code-header">
                    <span>Reactç»„ä»¶ä»£ç </span>
                    <button onclick="copyCode('component')" class="copy-btn">å¤åˆ¶</button>
                </div>
                <pre class="code-block"><code id="componentCodeContent"></code></pre>
            </div>
            <div id="processingCode" class="tab-content">
                <div class="code-header">
                    <span>æ•°æ®å¤„ç†ä»£ç </span>
                    <button onclick="copyCode('processing')" class="copy-btn">å¤åˆ¶</button>
                </div>
                <pre class="code-block"><code id="processingCodeContent"></code></pre>
            </div>
            <div id="configCode" class="tab-content">
                <div class="code-header">
                    <span>é…ç½®JSON</span>
                    <button onclick="copyCode('config')" class="copy-btn">å¤åˆ¶</button>
                </div>
                <pre class="code-block"><code id="configCodeContent"></code></pre>
            </div>
        </div>
    </div>

    <script>
        async function generateVisualization() {
            const btn = document.getElementById('generateBtn');
            const resultDiv = document.getElementById('result');
            const previewDiv = document.getElementById('visualizationPreview');
            const previewContent = document.getElementById('previewContent');
            
            // è·å–è¾“å…¥æ•°æ®
            const visualizationType = document.getElementById('visualizationType').value;
            const query = document.getElementById('query').value;
            const testDataText = document.getElementById('testData').value;
            
            if (!query.trim()) {
                showResult('è¯·è¾“å…¥å¯è§†åŒ–éœ€æ±‚æè¿°', 'error');
                return;
            }
            
            let testData;
            try {
                testData = JSON.parse(testDataText);
            } catch (e) {
                showResult('æµ‹è¯•æ•°æ®æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥JSONæ ¼å¼', 'error');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            btn.textContent = 'ç”Ÿæˆä¸­...';
            showResult('æ­£åœ¨ç”Ÿæˆå¯è§†åŒ–ä»£ç ...', 'loading');
            
            try {
                const response = await fetch('/api/v1/generate-visualization', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data: testData,
                        query: query,
                        visualization_type: visualizationType,
                        options: {}
                    }),
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult(`å¯è§†åŒ–ç”ŸæˆæˆåŠŸï¼ç±»å‹: ${result.visualization_type}`, 'success');
                    renderVisualization(result.visualization_type, result.config, testData);
                    generateCode(result.visualization_type, result.config, testData, query);
                } else {
                    showResult(`ç”Ÿæˆå¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                showResult(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'ç”Ÿæˆå¯è§†åŒ–ä»£ç ';
            }
        }
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.textContent = message;
            resultDiv.className = `result ${type}`;
            resultDiv.style.display = 'block';
        }
        
        function renderVisualization(type, config, data) {
            const previewDiv = document.getElementById('visualizationPreview');
            const previewContent = document.getElementById('previewContent');
            
            previewContent.innerHTML = '';
            
            if (type === 'table') {
                // æ¸²æŸ“è¡¨æ ¼
                const table = document.createElement('table');
                
                // åˆ›å»ºè¡¨å¤´
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                if (config.columns && config.columns.length > 0) {
                    config.columns.forEach(column => {
                        const th = document.createElement('th');
                        th.textContent = column.title || column.dataIndex;
                        headerRow.appendChild(th);
                    });
                } else if (data.length > 0) {
                    // å¦‚æœæ²¡æœ‰åˆ—é…ç½®ï¼Œä½¿ç”¨æ•°æ®å­—æ®µ
                    Object.keys(data[0]).forEach(key => {
                        const th = document.createElement('th');
                        th.textContent = key;
                        headerRow.appendChild(th);
                    });
                }
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // åˆ›å»ºè¡¨ä½“
                const tbody = document.createElement('tbody');
                const dataSource = config.dataSource || data;
                
                dataSource.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    if (config.columns && config.columns.length > 0) {
                        config.columns.forEach(column => {
                            const td = document.createElement('td');
                            td.textContent = row[column.dataIndex] || '';
                            tr.appendChild(td);
                        });
                    } else {
                        Object.values(row).forEach(value => {
                            const td = document.createElement('td');
                            td.textContent = value || '';
                            tr.appendChild(td);
                        });
                    }
                    
                    tbody.appendChild(tr);
                });
                
                table.appendChild(tbody);
                
                const tableContainer = document.createElement('div');
                tableContainer.className = 'table-container';
                tableContainer.appendChild(table);
                previewContent.appendChild(tableContainer);
                
            } else if (type === 'chart') {
                // æ¸²æŸ“å›¾è¡¨å ä½ç¬¦
                const chartDiv = document.createElement('div');
                chartDiv.className = 'chart-container';
                chartDiv.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“Š</div>
                            <div>å›¾è¡¨é…ç½®å·²ç”Ÿæˆ</div>
                            <div style="font-size: 12px; margin-top: 5px;">éœ€è¦åœ¨Reactç¯å¢ƒä¸­ä½¿ç”¨EChartsæ¸²æŸ“</div>
                        </div>
                    </div>
                `;
                previewContent.appendChild(chartDiv);
                
                // æ˜¾ç¤ºé…ç½®ä¿¡æ¯
                const configInfo = document.createElement('div');
                configInfo.style.marginTop = '20px';
                configInfo.innerHTML = `
                    <h4>å›¾è¡¨é…ç½®:</h4>
                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(config, null, 2)}</pre>
                `;
                previewContent.appendChild(configInfo);
            }
            
            previewDiv.style.display = 'block';
        }
        
        function generateCode(type, config, data, query) {
            const dataInfo = {
                rowCount: data.length,
                columns: data.length > 0 ? Object.keys(data[0]) : [],
                sampleData: data.slice(0, 3)
            };

            // ç”Ÿæˆç»„ä»¶ä»£ç 
            let componentCode = '';
            if (type === 'table') {
                componentCode = `// åŸºäº ${dataInfo.rowCount} è¡Œæ•°æ®ç”Ÿæˆçš„è¡¨æ ¼ç»„ä»¶
// æ•°æ®å­—æ®µ: ${dataInfo.columns.join(', ')}
// ç”¨æˆ·éœ€æ±‚: ${query}
// ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}

import React from 'react';
import { Table } from 'antd';

interface TableData {
${dataInfo.columns.map(col => `  ${col}: any;`).join('\n')}
}

interface GeneratedTableProps {
  data?: TableData[];
  loading?: boolean;
}

const GeneratedTable: React.FC<GeneratedTableProps> = ({ 
  data = ${JSON.stringify(data, null, 2)}, 
  loading = false 
}) => {
  // è¡¨æ ¼é…ç½® - åŸºäºAIç”Ÿæˆçš„é…ç½®
  const tableConfig = ${JSON.stringify(config, null, 2)};

  return (
    <div className="w-full overflow-x-auto">
      <Table 
        {...tableConfig}
        dataSource={data}
        loading={loading}
      />
    </div>
  );
};

export default GeneratedTable;`;
            } else if (type === 'chart') {
                componentCode = `// åŸºäº ${dataInfo.rowCount} è¡Œæ•°æ®ç”Ÿæˆçš„å›¾è¡¨ç»„ä»¶
// æ•°æ®å­—æ®µ: ${dataInfo.columns.join(', ')}
// ç”¨æˆ·éœ€æ±‚: ${query}
// ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}

import React, { useEffect, useRef } from 'react';
import * as echarts from 'echarts';

interface ChartData {
${dataInfo.columns.map(col => `  ${col}: any;`).join('\n')}
}

interface GeneratedChartProps {
  data?: ChartData[];
  height?: string | number;
}

const GeneratedChart: React.FC<GeneratedChartProps> = ({ 
  data = ${JSON.stringify(data, null, 2)}, 
  height = '400px' 
}) => {
  const chartRef = useRef<HTMLDivElement>(null);
  const chartInstance = useRef<echarts.ECharts | null>(null);

  // å›¾è¡¨é…ç½® - åŸºäºAIç”Ÿæˆçš„é…ç½®
  const chartConfig = ${JSON.stringify(config, null, 2)};

  useEffect(() => {
    if (chartRef.current) {
      if (chartInstance.current) {
        chartInstance.current.dispose();
      }
      chartInstance.current = echarts.init(chartRef.current);
      chartInstance.current.setOption(chartConfig);
    }

    return () => {
      if (chartInstance.current) {
        chartInstance.current.dispose();
      }
    };
  }, [chartConfig]);

  return (
    <div 
      ref={chartRef} 
      style={{ width: '100%', height }}
      className="border border-gray-200 rounded-lg"
    />
  );
};

export default GeneratedChart;`;
            }

            // ç”Ÿæˆæ•°æ®å¤„ç†ä»£ç 
            const numericColumns = dataInfo.columns.filter(col => 
                data.some(row => typeof row[col] === 'number')
            );
            const stringColumns = dataInfo.columns.filter(col => 
                data.some(row => typeof row[col] === 'string')
            );

            const processingCode = `// æ•°æ®å¤„ç†å·¥å…·å‡½æ•°
// åŸºäºåŸå§‹å“åº”æ•°æ® ${dataInfo.rowCount} è¡Œï¼Œ${dataInfo.columns.length} ä¸ªå­—æ®µ
// ç”¨æˆ·éœ€æ±‚: ${query}
// ç”Ÿæˆæ—¶é—´: ${new Date().toLocaleString()}

// æ•°æ®ç±»å‹å®šä¹‰
interface RawData {
${dataInfo.columns.map(col => `  ${col}: any;`).join('\n')}
}

interface ProcessedData extends RawData {
  // å¤„ç†åçš„æ•°æ®å¯èƒ½åŒ…å«é¢å¤–çš„è®¡ç®—å­—æ®µ
}

// 1. æ•°æ®é¢„å¤„ç†å’Œæ¸…ç†
export const processRawData = (rawData: RawData[]): ProcessedData[] => {
  // æ¸…ç†ç©ºå€¼å’Œæ— æ•ˆæ•°æ®
  const cleanedData = rawData.filter(row => 
    row !== null && row !== undefined && Object.keys(row).length > 0
  );
  
  // æ•°æ®ç±»å‹è½¬æ¢å’Œæ ‡å‡†åŒ–
  const processedData = cleanedData.map(row => ({
    ...row,
    // æ•°å€¼å­—æ®µè½¬æ¢
${numericColumns.map(col => `    ${col}: Number(row.${col}) || 0,`).join('\n')}
    // å­—ç¬¦ä¸²å­—æ®µæ¸…ç†
${stringColumns.map(col => `    ${col}: String(row.${col} || '').trim(),`).join('\n')}
  }));
  
  return processedData;
};

// 2. æ•°æ®èšåˆå‡½æ•°
export const aggregateData = <T extends keyof RawData>(
  data: ProcessedData[], 
  groupBy: T, 
  aggregateField: keyof RawData,
  operation: 'sum' | 'avg' | 'count' | 'max' | 'min' = 'avg'
): Array<{ [K in T]: any } & { value: number }> => {
  const groups: Record<string, number[]> = {};
  
  data.forEach(row => {
    const key = String(row[groupBy]);
    if (!groups[key]) {
      groups[key] = [];
    }
    const value = Number(row[aggregateField]);
    if (!isNaN(value)) {
      groups[key].push(value);
    }
  });
  
  return Object.entries(groups).map(([key, values]) => {
    let result: number;
    switch (operation) {
      case 'sum':
        result = values.reduce((sum, val) => sum + val, 0);
        break;
      case 'avg':
        result = values.reduce((sum, val) => sum + val, 0) / values.length;
        break;
      case 'count':
        result = values.length;
        break;
      case 'max':
        result = Math.max(...values);
        break;
      case 'min':
        result = Math.min(...values);
        break;
      default:
        result = values.reduce((sum, val) => sum + val, 0) / values.length;
    }
    
    return {
      [groupBy]: key,
      value: result
    } as any;
  });
};

// 3. æ•°æ®è¿‡æ»¤å‡½æ•°
export const filterData = (
  data: ProcessedData[], 
  conditions: Partial<Record<keyof RawData, any | ((value: any) => boolean)>>
): ProcessedData[] => {
  return data.filter(row => {
    return Object.entries(conditions).every(([field, condition]) => {
      const value = row[field as keyof RawData];
      
      if (typeof condition === 'function') {
        return condition(value);
      }
      
      return value === condition;
    });
  });
};

// 4. æ•°æ®æ’åºå‡½æ•°
export const sortData = <T extends keyof RawData>(
  data: ProcessedData[], 
  sortField: T, 
  order: 'asc' | 'desc' = 'asc'
): ProcessedData[] => {
  return [...data].sort((a, b) => {
    const aVal = a[sortField];
    const bVal = b[sortField];
    
    if (typeof aVal === 'number' && typeof bVal === 'number') {
      return order === 'asc' ? aVal - bVal : bVal - aVal;
    }
    
    const aStr = String(aVal || '');
    const bStr = String(bVal || '');
    
    if (order === 'asc') {
      return aStr.localeCompare(bStr);
    } else {
      return bStr.localeCompare(aStr);
    }
  });
};

// ä½¿ç”¨ç¤ºä¾‹:
// const processedData = processRawData(rawData);
// const aggregatedData = aggregateData(processedData, 'department', 'salary', 'avg');
// const filteredData = filterData(processedData, { status: 'active' });
// const sortedData = sortData(processedData, 'salary', 'desc');`;

            // æ˜¾ç¤ºä»£ç 
            document.getElementById('componentCodeContent').textContent = componentCode;
            document.getElementById('processingCodeContent').textContent = processingCode;
            document.getElementById('configCodeContent').textContent = JSON.stringify(config, null, 2);
            
            document.getElementById('codePreview').style.display = 'block';
        }

        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çš„activeç±»
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            document.getElementById(tabName + 'Code').classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾æŒ‰é’®
            event.target.classList.add('active');
        }

        function copyCode(type) {
            let code = '';
            if (type === 'component') {
                code = document.getElementById('componentCodeContent').textContent;
            } else if (type === 'processing') {
                code = document.getElementById('processingCodeContent').textContent;
            } else if (type === 'config') {
                code = document.getElementById('configCodeContent').textContent;
            }
            
            navigator.clipboard.writeText(code).then(() => {
                alert('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }

        // é¡µé¢åŠ è½½æ—¶è®¾ç½®é»˜è®¤æŸ¥è¯¢
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('query').value = 'ç”Ÿæˆä¸€ä¸ªæŒ‰éƒ¨é—¨ç»Ÿè®¡å¹³å‡è–ªèµ„çš„æŸ±çŠ¶å›¾';
        });
    </script>
</body>
</html> 